<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>3D Model Viewer</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Lexend+Deca:wght@100..900&display=swap" rel="stylesheet">

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-kenU1KFdBIe4zVF0s0G1M5b4hcpxyD9F7jL+jjXkk+Q2h455rYXK/7HAuoJl+0I4" crossorigin="anonymous"></script>

  <script src="https://static.sketchfab.com/api/sketchfab-viewer-1.12.1.js"></script>

  <style>
    :root {
      --bg-dark: #1a1a1a;
      --accent: #e85d26;
    }

    * { font-family: 'Lexend Deca', sans-serif; }
    html, body, .col-12 { padding: 0 !important; margin: 0 !important; }
    body { background-color: var(--bg-dark); }

    .col-12 { height: 100vh; overflow: hidden; position: relative; }
    .api-frame { width: 100%; height: 100%; border: none; }

    .loading-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      transition: opacity 0.5s ease;
    }
    .loading-overlay.hidden { opacity: 0; pointer-events: none; }
    .loading-overlay .spinner-border { width: 3rem; height: 3rem; color: var(--accent); }
  </style>
</head>

<body>
  <div class="container-fluid">
    <div class="row">

      <div class="col-12">
        <div class="loading-overlay" id="loadingOverlay">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
        <iframe
          src=""
          id="api-frame"
          class="api-frame"
          sandbox="allow-scripts allow-same-origin allow-popups allow-forms"
          allow="autoplay; fullscreen; xr-spatial-tracking"
          xr-spatial-tracking execution-while-out-of-viewport execution-while-not-rendered web-share
          allowfullscreen mozallowfullscreen="true" webkitallowfullscreen="true">
        </iframe>
      </div>

    </div>
  </div>

  <script>
    (function () {
      'use strict';

      /* ================================================================
         CONFIG — only edit this block when setting up a new model
         ================================================================

         uid            → Sketchfab model ID (from the model URL)
         apiVersion     → leave as-is unless Sketchfab releases a newer version
         defaultVariant → the variant name that loads first on page open
         alwaysVisible  → objects that should always stay visible (e.g. Floor)
         variants       → all variant names exactly as they appear in Blender
                          (names are case-sensitive)

         annotations    → each annotation is a hotspot on the 3D model
           position     → 3D point on the surface where the pin sits
                          (copy from annotationGetter.html)
           eye          → camera position when annotation is selected
                          (copy from annotationGetter.html)
           target       → camera look-at point
                          (copy from annotationGetter.html)
           cycle        → list of variants this annotation toggles through
                          each click advances to the next item in the list
             variant    → must exactly match a name in the variants array
             title      → label shown in the annotation tooltip

         To add a new annotation: copy one annotation block { ... },
         paste it inside the annotations array, and fill in the values.
         ================================================================ */
      var CONFIG = {
        uid:            '866c979dbf32463e9afc868d9662dc62',
        apiVersion:     '1.12.1',
        defaultVariant: 'PM-TTA45 APEX A',
        alwaysVisible:  ['Floor'],
        variants: [
          'PM-TTA45 APEX A',
          'PM-TTA45 APEX A-RDM',
          'PM-TTA45 APEX B',
          'PM-TTA45 APEX B-RDM',
          'PM-TTA45 BASECAMP',
          'PM-TTA45 BASECAMP-BS',
          'PM-TTA45 BASECAMP-DS',
          'PM-TTA45 BASECAMP-PS'
        ],
        annotations: [
          {
            position: [3.4361,   4.3742,   3.5489],
            eye:      [-11.4045, -15.4450,  5.7509],
            target:   [1.4724,   5.4694,   3.9603],
            cycle: [
              { variant: 'PM-TTA45 APEX A',     title: 'Layout A: No Rear Drawer'     },
              { variant: 'PM-TTA45 APEX A-RDM', title: 'Layout A: Rear Drawer Module' }
            ]
          },
          {
            position: [-3.1821,  4.8264,   3.9981],
            eye:      [14.9553,  -15.1106, 5.0145],
            target:   [1.4724,   5.4694,   3.9603],
            cycle: [
              { variant: 'PM-TTA45 APEX B',     title: 'Layout B: No Rear Drawer'     },
              { variant: 'PM-TTA45 APEX B-RDM', title: 'Layout B: Rear Drawer Module' }
            ]
          }
        ]
      };
      /* ================================================================
         END CONFIG
         ================================================================ */

      var api = null, currentVariant = null, viewerReady = false, annotationsReady = false;

      var annotationState = CONFIG.annotations.map(function () {
        return { cycleIndex: 0 };
      });

      var iframe = document.querySelector('.api-frame');
      var client = new Sketchfab(CONFIG.apiVersion, iframe);

      client.init(CONFIG.uid, {
        success: onSuccess,
        error: function () { console.error('[Sketchfab] Error loading model'); },
        autostart: 1,
        ui_watermark: 0,
        ui_infos: 0,
        ui_controls: 0
      });

      function onSuccess(apiInstance) {
        api = apiInstance;
        api.start(function () {
          api.addEventListener('viewerready', function () {
            buildNodeMap(function () {
              hideAllVariants(function () {
                showModel(CONFIG.defaultVariant);
                document.getElementById('loadingOverlay').classList.add('hidden');
                viewerReady = true;

                CONFIG.annotations.forEach(function (ann) {
                  api.createAnnotationFromScenePosition(
                    ann.position,
                    ann.eye,
                    ann.target,
                    ann.cycle[0].title,
                    ''
                  );
                });

                annotationsReady = true;

                api.addEventListener('annotationSelect', function (index) {
                  var ann   = CONFIG.annotations[index];
                  var state = annotationState[index];
                  if (!ann) return;

                  state.cycleIndex = (state.cycleIndex + 1) % ann.cycle.length;
                  var step = ann.cycle[state.cycleIndex];

                  api.updateAnnotation(index, { title: step.title, description: '' });
                  showModel(step.variant);
                });

              });
            });
          });
        });
      }

      function syncAnnotations(variantName) {
        if (!annotationsReady) return;
        CONFIG.annotations.forEach(function (ann, i) {
          ann.cycle.forEach(function (step, j) {
            if (step.variant === variantName) {
              annotationState[i].cycleIndex = j;
              api.updateAnnotation(i, { title: step.title, description: '' });
            }
          });
        });
      }

      function buildNodeMap(cb) {
        api.getNodeMap(function (err, nodes) {
          if (err) { console.error('[Sketchfab] getNodeMap error:', err); if (cb) cb(); return; }
          console.log('%c[NodeMap] ======== ALL NODES ========', 'color:#e85d26;font-weight:bold');
          for (var k in nodes) {
            if (nodes[k].name) {
              console.log('  "' + nodes[k].name + '"  id:' + nodes[k].instanceID);
            }
          }
          console.log('%c[NodeMap] =============================', 'color:#e85d26;font-weight:bold');
          if (cb) cb();
        });
      }

      function hideAllVariants(cb) {
        var pending = CONFIG.variants.length;
        CONFIG.variants.forEach(function (v) {
          toggleCollection(v, false, function () { if (--pending === 0 && cb) cb(); });
        });
      }

      function showModel(variantName) {
        if (CONFIG.variants.indexOf(variantName) === -1) {
          console.warn('[Sketchfab] Unknown variant:', variantName);
          return;
        }
        CONFIG.variants.forEach(function (v) { toggleCollection(v, v === variantName); });
        CONFIG.alwaysVisible.forEach(function (v) { toggleCollection(v, true); });
        currentVariant = variantName;
        console.log('[Sketchfab] Showing:', variantName);
        syncAnnotations(variantName);
      }

      function toggleCollection(colName, show, cb) {
        api.getNodeMap(function (err, nodes) {
          if (err) { if (cb) cb(); return; }
          for (var k in nodes) {
            var n = nodes[k];
            if (n.name && (n.name === colName || n.name.indexOf(colName + '_') === 0)) {
              show ? api.show(n.instanceID) : api.hide(n.instanceID);
            }
          }
          if (cb) cb();
        });
      }

      window.showModel         = showModel;
      window.getCurrentVariant = function () { return currentVariant; };
      window.sketchfabApi      = function () { return api; };
      window.isViewerReady     = function () { return viewerReady; };

    })();
  </script>

</body>
</html>
